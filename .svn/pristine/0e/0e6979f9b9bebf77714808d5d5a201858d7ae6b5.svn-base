import {Component, ViewChild} from '@angular/core';
import {NavController, App, Platform, Content} from 'ionic-angular';
import {CallNumber} from '@ionic-native/call-number';
import {DrivingDirectionsPage} from '../driving-directions/driving-directions';
import {LoginPage} from '../login/login';
import {GoogleMapsManager} from '../../providers/google-maps-manager';
import {Geolocation} from '@ionic-native/geolocation';
import {TaskManager} from '../../providers/task-manager';
import {UserManager} from '../../providers/user-manager';
import {Utils} from '../../utils/utils';
import {Animations} from '../../animations/animations';
import {Diagnostic} from "@ionic-native/diagnostic";
import {StorageService} from '../../providers/storage-service'

@Component({
    selector: 'page-foreman',
    templateUrl: 'foreman.html',
    animations: [
        Animations.expandCollapse
    ]
})

export class ForemanPage {
    @ViewChild(Content) content: Content;

    tasks: any;
    showTasks: boolean = true;
    divState: string = 'hide';
    newStart: any = '';
    expandTaskId: number = -1;
    taskId: number = -1;
    delayNotes: any = [];
    employeeId: number = -1;
    isIos: boolean = false;
    public displayOptions = {
        proj: -1,
        task: -1
    };
    detailedStats: any = {
        proj: -1,
        emp: -1
    };
    url: string = "https://www.cleartasksolutions.com/uploads/";


    projTaskLength: any = {
        proj: 0,
        task: 0
    };
    newDay: any;
    currentDate: any = '-1';
    search: boolean = false;

    previousTasks: any;
    previousProjects: number = 0;


    constructor(public navCtrl: NavController,
                public taskMgr: TaskManager,
                public plt: Platform,
                private mapsManager: GoogleMapsManager,
                private userMgr: UserManager,
                private appCtrl: App,
                private geolocation: Geolocation,
                private utils: Utils,
                private callNumber: CallNumber,
                private storage: StorageService,
                private diagnostic: Diagnostic) {

        this.divState = 'collapse';

        if (this.plt.is('ios')) {
            this.isIos = true;
        }
    }

    ionViewDidLoad() {
        console.log('View is loaded');
        // this.getForemanTasks();
    }

    ionViewWillEnter() {
        console.log('HomePage View is entered');
        this.getForemanTasks();
    }

    toggleDivState() {
        let states = {
            expand: 'collapse',
            collapse: 'expand'
        };
        this.divState = states[this.divState];
    }

    // /** logs the user out of the app */
    logout() {
        this.userMgr.logout().then(response => {
            this.appCtrl.getRootNav().push(LoginPage);
        })
    }

    callPhone(number) {
        this.callNumber.callNumber(number, false)
            .then(() => console.log('Launched dialer!'))
            .catch(() => console.log('Error launching dialer'));
    }

    //  callPhone(mobNumber: string) {
    //     window.open("tel:" + '1' + mobNumber);
    // }

    getForemanTasks() {
        this.search = false;
        if (this.currentDate === '-1') {
            let interimTime = new Date(Date.now());
            let myZone = interimTime.getTimezoneOffset();
            let year = interimTime.getFullYear();
            let month = interimTime.getMonth();
            let day = interimTime.getUTCDate();
            console.log('day', JSON.stringify(day));
            let hour = interimTime.getUTCHours() - (myZone / 60);
            let minute = interimTime.getUTCMinutes();
            let seconds = interimTime.getUTCSeconds();
            let adjustTimezone = new Date(Date.UTC(year, month, day, hour, minute, seconds));
            let timeZero = adjustTimezone.setHours(0, 0, 0, 0);
            this.currentDate = new Date(timeZero).toISOString().slice(0, 10);
        }
        this.utils.presentLoading();
        console.log('this.currentDate ', JSON.stringify(this.currentDate));
        this.taskMgr.loadForemanTasks(this.currentDate).then((response: any) => {
            this.tasks = response.data;
            console.log('this.tasks ', JSON.stringify(this.tasks));


            // Ugly code for parsing the time since iOS doesn't allow date pipes with multiple key/value pairs
            for (let i = 0; i < this.tasks.length; i++) {
                this.projTaskLength.proj = this.tasks.length;

                let projectTasks = this.tasks[i].job_tasks;
                this.projTaskLength.task += this.tasks[i].job_tasks.length;

                for (let j = 0; j < projectTasks.length; j++) {
                    console.log('projectTasks ', JSON.stringify(projectTasks));

                    if(projectTasks[j].additional_notes) {
                        console.log('projectTasks[j].additional_notes ', JSON.stringify(projectTasks[j].additional_notes));
                        for(let l = 0; l < projectTasks[j].additional_notes.length; l++) {
                            projectTasks[j].additional_notes[l].new_time = this.adjustTime(projectTasks[j].additional_notes[l].timestamp);
                        }
                    }


                    for (let k = 0; k < projectTasks[j].task_crew.length; k++) {
                        let myfilter = projectTasks[j].task_crew_status.filter(function (myfilter) {
                            return myfilter.employee_id === projectTasks[j].task_crew[k].employee_id
                        });
                        projectTasks[j].task_crew[k].statusLog = myfilter;

                    }

                    projectTasks[j].newStart = projectTasks[j].task_start_time;
                    let combined = projectTasks[j].newStart[0] + '' + projectTasks[j].newStart[1];
                    let combinedInt = parseInt(combined);
                    let newTime: string;
                    if (combinedInt > 12) {
                        combinedInt -= 12;
                        newTime = combinedInt + ':' + projectTasks[j].newStart[3] + projectTasks[j].newStart[4] + ' ' + 'PM';
                    } else if (combinedInt > 9 && combinedInt <= 12) {
                        newTime = combinedInt + ':' + projectTasks[j].newStart[3] + projectTasks[j].newStart[4] + ' ' + 'AM';
                    } else if (combinedInt < 10) {
                        let morning = projectTasks[j].newStart[1];
                        newTime = morning + ':' + projectTasks[j].newStart[3] + projectTasks[j].newStart[4] + ' ' + 'AM';
                    }
                    projectTasks[j].newTime = newTime;


                }

                projectTasks.sort(function (a, b) {
                    return (a.task_start_time > b.task_start_time) ? 1 : ((b.task_start_time > a.task_start_time) ? -1 : 0);
                });

                console.log('this.projTaskLength ', JSON.stringify(this.projTaskLength));

                console.log('projectTasks ', JSON.stringify(projectTasks));


            }
            console.log('this.projTaskLength ', JSON.stringify(this.projTaskLength));
            this.utils.dismissLoading();

        });

        console.log('tasks ', JSON.stringify(this.tasks));
    }

    loadCurrentDay() {
        this.currentDate = '-1';
        this.getForemanTasks();

    }

    loadNotes(empId, taskId) {


        if (this.employeeId === empId) {
            this.employeeId = -1;
        } else {
            this.utils.presentLoading();

            this.employeeId = empId;
            this.taskMgr.loadSpecificTaskUserLog(empId, taskId).then((response: any) => {

                this.delayNotes = [];
                for (let i = 0; i < response.data.length; i++) {
                    if (response.data[i].status_id === 5 || response.data[i].status_id === 6 || response.data[i].status_id === 7 || response.data[i].status_id === 12) {
                        let note = response.data[i].notes;
                        let combined = response.data[i].timestamp[11] + '' + response.data[i].timestamp[12];
                        let combinedInt = parseInt(combined);
                        let time = '';

                        if (combinedInt > 12) {
                            combinedInt -= 12;
                            time = combinedInt + ':' + response.data[i].timestamp[14] + response.data[i].timestamp[15] + ' ' + 'PM';
                        } else if (combinedInt > 9 && combinedInt <= 12) {
                            time = combinedInt + ':' + response.data[i].timestamp[14] + response.data[i].timestamp[15] + ' ' + 'AM';
                        } else if (combinedInt < 10) {
                            let morning = response.data[i].timestamp[12];

                            time = morning + ':' + response.data[i].timestamp[14] + response.data[i].timestamp[15] + ' ' + 'AM';
                        }


                        let newEntry = {
                            notes: note,
                            timestamp: time,
                            images: []
                        };

                        if (response.data[i].fileData.length > 0) {
                            for (let j = 0; j < response.data[i].fileData.length; j++) {
                                let image = this.url + response.data[i].fileData[j].file_name;

                                newEntry.images.push(image);
                            }
                        }


                        this.delayNotes.push(newEntry);
                    }
                }

                this.utils.dismissLoading();
            })
        }

    }

    refreshCrews() {
        this.getForemanTasks();
    }

    showDrivingDirections(lat, lon) {
        this.utils.presentLoading();
        let locEnabled: boolean = false;

        let successCallback = (isAvailable) => {
            if (isAvailable) {
                locEnabled = true;
                return locEnabled;
            } else {
                this.utils.presentToast("Please enable your location in device settings", true);
                return;
            }
        };
        let errorCallback = (e) => {
            this.utils.presentToast("Please enable your location in device settings", true);
            this.utils.dismissLoading();
        };

        this.diagnostic.isLocationEnabled().then(successCallback).then(resp => {
            if (locEnabled) {
                let destination = `${lat},${lon}`;
                this.geolocation.getCurrentPosition({timeout: 15000}).then((position) => {
                    let origin = `${position.coords.latitude},${position.coords.longitude}`;
                    return this.mapsManager.getDirections(origin, destination);
                }).then((response) => {
                    let params = {
                        directions: response
                    };
                    setTimeout(() => {
                        this.navCtrl.push(DrivingDirectionsPage, params);
                        this.utils.dismissLoading();
                    }, 2000)
                }).catch((error) => {
                    this.utils.dismissLoading();

                    this.utils.presentToast("Please enable your location in device settings", true);
                })
            }
            if (locEnabled === false) {
                this.utils.dismissLoading();
            }
        }).catch(errorCallback);
    }


    detailedStatus(proj, emp) {


        if ((this.detailedStats.proj === -1 && this.detailedStats.emp === -1) || (this.detailedStats.proj !== proj && this.detailedStats.emp !== emp) || (this.detailedStats.proj === proj && this.detailedStats.emp !== emp)) {
            this.detailedStats.proj = proj;
            this.detailedStats.emp = emp;
        }
        else if (this.detailedStats.proj === proj && this.detailedStats.emp === emp) {
            this.detailedStats.proj = -1;
            this.detailedStats.emp = -1;
        }
        else {
            this.detailedStats.proj = -1;
            this.detailedStats.emp = -1;
        }
    }

    convertTime(timestamp) {

        let combined = timestamp[11] + '' + timestamp[12];
        let combinedInt = parseInt(combined);
        let time = '';

        if (combinedInt > 12) {
            combinedInt -= 12;
            time = combinedInt + ':' + timestamp[14] + timestamp[15] + ' ' + 'PM';
        } else if (combinedInt > 9 && combinedInt <= 12) {
            time = combinedInt + ':' + timestamp[14] + timestamp[15] + ' ' + 'AM';
        } else if (combinedInt < 10) {
            let morning = timestamp[12];
            time = morning + ':' + timestamp[14] + timestamp[15] + ' ' + 'AM';
        }
        return time;
    }

    setBackground(crew) {
        let cssClasses;

        if (crew.status_id === 3 && crew.role_id === 6) {
            cssClasses = {
                'completed': true
            }
        } else if (crew.status_id === 3) {
            cssClasses = {
                'accepted': true
            }
        } else if (crew.status_id === 4) {
            cssClasses = {
                'started': true
            }
        } else if (crew.status_id === 9) {
            cssClasses = {
                'completed': true
            }
        } else if (crew.status_id === 7) {
            cssClasses = {
                'emergency': true
            }
        } else if (crew.status_id === 8) {
            cssClasses = {
                'rejected': true
            }
        } else if (crew.status_id === 2 || crew.status_id === 1) {
            cssClasses = {
                'sent': true
            }

        } else if (crew.status_id === 11) {
            cssClasses = {
                'cancelled': true
            }
        } else if (crew.status_id === 12 || crew.status_id === 5 || crew.status_id === 13 || crew.status_id === 6) {
            cssClasses = {
                'temporary': true
            }
        }

        return cssClasses
    }

    getEmployeeName(emps: any, equip) {

        equip.name = '';


        for (let i = 0; i < emps.length; i++) {
            if (emps[i].employee_id === equip.employee_id) {
                equip.name = emps[i].first_name + " " + emps[i].last_name;
            }
        }

        return equip.name;

    }

    expandTask(i, j) {
        let proj = i + 1;
        let task = j;
        this.employeeId = -1;

        if (this.displayOptions.proj === i && this.displayOptions.task === j) {
            if (!this.isIos) {
                this.content.scrollTo(0, 0, 300).then(res => {
                    console.log('res', JSON.stringify(res));
                });
            }
            this.displayOptions = {
                proj: -1,
                task: -1
            };
        } else {
            if (!this.isIos) {
                if (i === 0) {
                    this.content.scrollTo(0, ((proj * 153) + (task * 49)), 300).then(res => {
                        let projTotal = proj * 153;
                        let taskTotal = task * 49;
                    });
                } else {
                    let prevTasks = this.findProjectsAndTasks(i);
                    this.content.scrollTo(0, ((157 * i) + (prevTasks * 49) + ((task + 1) * 49) + 118 + ((i * 10))), 300).then(res => {
                        let projTotal = ((157 * i) + (prevTasks * 49) + ((task + 1) * 49) + 128);
                    });
                }
            }
            this.displayOptions = {
                proj: i,
                task: j
            };
        }
        return this.displayOptions;
    }


    findProjectsAndTasks(proj) {
        this.previousProjects = proj;
        let prevTasks = 0;
        for (let i = 0; i < proj; i++) {
            prevTasks += this.tasks[i].job_tasks.length;
        }
        this.previousTasks = prevTasks;
        return this.previousTasks;
    }

    adjustTime(time) {

        let date = time.slice(0, 10);
        let act_time = time.slice(11, 18);

        let date_time = act_time + ' ' + date;
        let combined = act_time[0] + '' + act_time[1];
        let combinedInt = parseInt(combined);
        let returned_time = '';

        // Code to fix how the time shows up, it has been compressed to save room

        if (combinedInt > 12) {
            combinedInt -= 12;
            returned_time = combinedInt + ':' + act_time[3] + act_time[4] + ' ' + 'PM';
        }
        else if (combinedInt === 12) {
            returned_time = combinedInt + ':' + act_time[3] + act_time[4] + ' ' + 'PM';
        }
        else if (combinedInt > 9 && combinedInt < 12) {
            returned_time = combinedInt + ':' + act_time[3] + act_time[4] + ' ' + 'AM';
        }
        else if (combinedInt < 10) {
            let morning = act_time[1];
            returned_time = morning + ':' + act_time[3] + act_time[4] + ' ' + 'AM';
        }

        return returned_time




    }

}
