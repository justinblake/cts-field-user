<ion-header xmlns="http://www.w3.org/1999/html">
    <ion-navbar *ngIf="isIos">
        <ion-row>
            <ion-col width-50>
                <div text-center>
                    <div class="ios-title">
                        Crews
                    </div>
                </div>
            </ion-col>

            <ion-col width-25>
                <ion-buttons class="mar-right6" end>
                    <button class="refresh" ion-button round icon-right color="secondary"
                            (click)="refreshCrews()"> Refresh
                        <ion-icon class="logout-hide" name="refresh"></ion-icon>
                    </button>
                </ion-buttons>
            </ion-col>
        </ion-row>
    </ion-navbar>
    <ion-navbar *ngIf="!isIos">


        <ion-buttons class="mar-right6" end>
            <button class="refresh" ion-button round icon-right color="secondary"
                    (click)="refreshCrews()"> Refresh
                <ion-icon name="refresh"></ion-icon>
            </button>
        </ion-buttons>
        <ion-title>Crews</ion-title>
    </ion-navbar>

</ion-header>

<ion-content footer>

    <ion-card class="manage-app">
        <ion-card-header class="task-card-header">
            <div *ngIf="!search">
                <ion-buttons text-center>
                    <button color="secondary" ion-button block icon-left
                            (click)="search = !search">
                        <ion-icon name="search"></ion-icon>
                        Search Future Crew's Tasks
                    </button>
                </ion-buttons>
            </div>
            <div *ngIf="search">
                <ion-item>
                    <ion-label>Foreman Task Search</ion-label>
                    <ion-datetime displayFormat="MM/DD/YYYY" pickerFormat="MMM D YYYY"
                                  [(ngModel)]="currentDate"></ion-datetime>
                </ion-item>
                <ion-row>
                    <ion-col width-50>
                        <ion-buttons text-center>
                            <button color="primary" ion-button block icon-left
                                    (click)="loadCurrentDay()">
                                Today's Tasks
                            </button>
                        </ion-buttons>
                    </ion-col>
                    <ion-col width-50>
                        <ion-buttons text-center>
                            <button color="secondary" ion-button block icon-left
                                    (click)="getForemanTasks()">
                                <ion-icon name="search"></ion-icon>
                                Search
                            </button>
                        </ion-buttons>
                    </ion-col>
                </ion-row>
            </div>

        </ion-card-header>
    </ion-card>

    <div *ngIf="showTasks">
        <div *ngIf="tasks">
            <ion-card class="card-space" *ngFor="let project of tasks; let i = index">
                <ion-card-header class="task-card-header">
                    {{project.job_name}}
                </ion-card-header>
                <ion-card-content [@expandCollapse]="divState">

                    <div [@expandCollapse]="divState" class="task-card-content">
                        <ion-list [@expandCollapse]="divState" no-padding>
                            <ion-item [@expandCollapse]="divState" no-padding>
                                <div [@expandCollapse]="divState">{{project.address}}</div>
                                <div [@expandCollapse]="divState">{{project.city}}, {{project.state}}&nbsp;{{project.zip}}</div>
                            </ion-item>
                        </ion-list>
                    </div>
                    <div [@expandCollapse]="divState" class="mar-bot25">
                        <p [@expandCollapse]="divState" class="bold">Contractor:</p>
                        <p [@expandCollapse]="divState">
                            {{project.contractor[0].name}}</p>
                        <p [@expandCollapse]="divState" class="bold">Office Phone:</p>
                        <p [@expandCollapse]="divState">
                            <button [@expandCollapse]="divState" ion-button icon-left clear medium
                                    class="contractorPhoneNum"
                                    (click)="callPhone(project.contractor[0].office_phone)">
                                {{project.contractor[0].office_phone}}
                            </button>
                        </p>
                    </div>
                </ion-card-content>

                <div no-padding class="more-back move-up">
                    <ion-row>
                        <ion-col>
                            <button class="more-left" ion-button icon-left clear medium (click)="toggleDivState()">
                                {{divState == 'collapse' ? 'More' : 'Less'}}...
                            </button>
                        </ion-col>
                        <ion-col text-right>
                            <button class="pad8" ion-button icon-left clear medium
                                    (click)="showDrivingDirections(project.lat, project.lon)">
                                <ion-icon name="navigate"></ion-icon>
                                Get Directions
                            </button>
                        </ion-col>
                    </ion-row>
                </div>


                <ion-card-content>

                    <div *ngFor="let task of project.job_tasks; let j = index">

                        <div class="card-width">
                            <ion-grid class="task-button">
                                <ion-row (click)="expandTask(i, j)">

                                    <ion-col class="task-text" text-left *ngIf="j === 0" width-70>
                                        <span *ngIf="displayOptions.proj !== i || displayOptions.task !== j">{{task.task_description}}</span>
                                        <span class="hideDetails"
                                              *ngIf="displayOptions.task === j && displayOptions.proj === i">Hide Details</span>

                                    </ion-col>
                                    <ion-col class="task-text" text-left *ngIf="j > 0" width-70>
                                        <span *ngIf="displayOptions.proj !== i || displayOptions.task !== j">{{task.task_description}}</span>
                                        <span class="hideDetails"
                                              *ngIf="displayOptions.task === j && displayOptions.proj === i">Hide Details</span>
                                    </ion-col>
                                    <ion-col width-30 class="newTime" text-right>
                                        <span *ngIf="displayOptions.proj !== i || displayOptions.task !== j">{{task.newTime}}</span>

                                    </ion-col>

                                </ion-row>
                            </ion-grid>


                            <div class="next-space" *ngIf="displayOptions.task === j && displayOptions.proj === i">


                                <ion-card class="card-border">
                                    <ion-card-header class="task-card-header">
                                        Task Details
                                    </ion-card-header>
                                    <ion-card-content>
                                        <div class="task-card-content">
                                            <ion-list no-padding text-wrap>
                                                <ion-item no-padding text-wrap>
                                                    <h4 class="text-info capitalize">
                                                        {{task.task_description}}</h4>
                                                    <h5 class="s-time">
                                                        Start Time: {{task.newTime}}
                                                    </h5>

                                                </ion-item>



                                                <div *ngIf="task.additional_notes.length > 0">
                                                    <h5 class="text-info">Additional Task Notes</h5>
                                                    <ion-item no-padding text-wrap
                                                              *ngFor="let newNotes of task.additional_notes; let u = index">
                                                        <h5 class="add_notes">{{u + 1}}: {{newNotes.notes}}</h5>
                                                        <h5 class="add_by">Added By: <strong>{{newNotes.employee.first_name}}
                                                            {{newNotes.employee.last_name}}</strong> at
                                                            {{newNotes.new_time}}</h5>


                                                    </ion-item>
                                                </div>
                                            </ion-list>
                                        </div>
                                    </ion-card-content>
                                </ion-card>

                                <ion-card class="card-border" *ngIf="task.contractor_contacts.length > 0">
                                    <ion-card-header class="task-card-header">
                                        Contractor Contacts
                                    </ion-card-header>
                                    <ion-card-content>
                                        <div class="task-card-content">
                                            <ion-list no-padding text-wrap>
                                                <ion-item no-padding text-wrap
                                                          *ngFor="let contact of task.contractor_contacts; let p = index ">
                                                    <h4 class="emp-font">
                                                        {{p + 1}}: {{contact.first_name}} {{contact.last_name}}
                                                    </h4>
                                                    <h4 class="contractor-title" *ngIf="contact.title"><span
                                                            class="bold">Title: </span>{{contact.title}}</h4>

                                                    <p>
                                                        <button ion-button icon-left clear medium
                                                                class="foremanPhone contractorPhone"
                                                                (click)="callPhone(contact.office_phone)">
                                                            {{contact.office_phone}}
                                                        </button>
                                                    </p>

                                                </ion-item>
                                            </ion-list>
                                        </div>
                                    </ion-card-content>
                                </ion-card>

                                <ion-card class="card-border">
                                    <ion-card-header class="task-card-header">
                                        Crew Status
                                    </ion-card-header>
                                    <ion-card-content>
                                        <div class="task-card-content">


                                            <ion-row
                                                    *ngFor="let crewMember of task.task_crew; let k = index">
                                                <ion-col [ngClass]="setBackground(crewMember)">
                                                    <h4 class="emp-font">{{k + 1}}: {{crewMember.first_name}}
                                                        {{crewMember.last_name}} </h4>
                                                    <h4 class="indent19" *ngIf="crewMember.is_foreman === 1"> --
                                                        Foreman
                                                        --</h4>
                                                    <p class="crew-phone">
                                                        <button ion-button icon-left clear medium
                                                                class="foremanPhone"
                                                                (click)="callPhone(crewMember.phone)">
                                                            {{crewMember.phone}}
                                                        </button>
                                                    </p>
                                                    <h4 class="job-status" *ngIf="crewMember.status_id === 1">
                                                        Current
                                                        Status: New</h4>

                                                    <h4 class="job-status" *ngIf="crewMember.status_id === 2">
                                                        Current
                                                        Status: Sent</h4>
                                                    <h4 class="job-status" *ngIf="crewMember.status_id === 3">
                                                        Current
                                                        Status: <span ion-text color="accepted">Accepted</span>
                                                    </h4>
                                                    <h4 class="job-status" *ngIf="crewMember.status_id === 4">
                                                        Current
                                                        Status: <span ion-text color="started">Started</span>
                                                    </h4>
                                                    <h4 class="job-status" *ngIf="crewMember.status_id === 5">
                                                        Current
                                                        Status: <span ion-text color="on-hold">Delayed</span>
                                                    </h4>
                                                    <h4 class="job-status" *ngIf="crewMember.status_id === 6">
                                                        Current
                                                        Status: <span ion-text color="on-hold">On Hold</span>
                                                    </h4>
                                                    <h4 class="job-status" *ngIf="crewMember.status_id === 7">
                                                        Current
                                                        Status: <span ion-text color="on-hold">Emergency</span>
                                                    </h4>
                                                    <h4 class="job-status" *ngIf="crewMember.status_id === 11">
                                                        Current
                                                        Status: <span ion-text
                                                                      color="on-hold">Cancelled</span>
                                                    </h4>
                                                    <h4 class="job-status" *ngIf="crewMember.status_id === 12">
                                                        Current
                                                        Status: <span ion-text
                                                                      color="on-hold">Temporary Hold</span>
                                                    </h4>
                                                    <h4 class="job-status" *ngIf="crewMember.status_id === 13">
                                                        Current
                                                        Status: <span ion-text
                                                                      color="on-hold">Timecard Pause</span>
                                                    </h4>
                                                    <h4 class="job-status" *ngIf="crewMember.status_id === 8">
                                                        Current
                                                        Status: <span ion-text color="on-hold">Rejected</span>
                                                    </h4>
                                                    <h4 class="job-status" *ngIf="crewMember.status_id === 9">
                                                        Current
                                                        Status: <span ion-text color="complete">Completed</span>
                                                    </h4>

                                                    <h4 class="margin-left18 link-blue" *ngIf="crewMember.statusLog.length > 0"
                                                        (click)="detailedStatus(j, k)">
                                                        View Detailed Status History
                                                        <ion-icon *ngIf="detailedStats.emp !== k"
                                                                  name="arrow-dropright"></ion-icon>
                                                        <ion-icon
                                                                *ngIf="detailedStats.proj === j && detailedStats.emp === k"
                                                                name="arrow-dropdown"></ion-icon>
                                                    </h4>
                                                    <div *ngIf="detailedStats.proj === j && detailedStats.emp === k">
                                                        <div *ngFor="let status of crewMember.statusLog">
                                                            <h4 class="job-status"
                                                                *ngIf="status.status_id === 3">
                                                                <span ion-text color="accepted">Accepted </span>
                                                                at
                                                                {{convertTime(status.timestamp)}}
                                                                <span *ngIf="status.notes"><br>Notes: {{status.notes}}</span>
                                                            </h4>
                                                            <h4 class="job-status"
                                                                *ngIf="status.status_id === 4">
                                                                <span ion-text color="started">Started</span> at
                                                                {{convertTime(status.timestamp)}}
                                                                <span *ngIf="status.notes"><br>Notes: {{status.notes}}</span>
                                                            </h4>
                                                            <h4 class="job-status"
                                                                *ngIf="status.status_id === 5">
                                                                <span ion-text color="on-hold">Delayed</span> at
                                                                {{convertTime(status.timestamp)}}
                                                                <span *ngIf="status.notes"><br>Notes: {{status.notes}}</span>
                                                            </h4>
                                                            <h4 class="job-status"
                                                                *ngIf="status.status_id === 6">
                                                                <span ion-text color="on-hold">On Hold</span> at
                                                                {{convertTime(status.timestamp)}}
                                                                <span *ngIf="status.notes"><br>Notes: {{status.notes}}</span>
                                                            </h4>
                                                            <h4 class="job-status"
                                                                *ngIf="status.status_id === 7">
                                                                <span ion-text color="on-hold">Emergency</span>
                                                                at
                                                                {{convertTime(status.timestamp)}}
                                                                <span *ngIf="status.notes"><br>Notes: {{status.notes}}</span>
                                                            </h4>
                                                            <h4 class="job-status"
                                                                *ngIf="status.status_id === 12">
                                                                <span ion-text
                                                                      color="on-hold">Temporary Hold</span> at
                                                                {{convertTime(status.timestamp)}}
                                                                <span *ngIf="status.notes"><br>Notes: {{status.notes}}</span>
                                                            </h4>
                                                            <h4 class="job-status"
                                                                *ngIf="status.status_id === 13">
                                                                <span ion-text
                                                                      color="on-hold">Timecard Pause</span> at
                                                                {{convertTime(status.timestamp)}}
                                                                <span *ngIf="status.notes"><br>Notes: {{status.notes}}</span>
                                                            </h4>
                                                            <h4 class="job-status"
                                                                *ngIf="status.status_id === 8">
                                                                <span ion-text color="on-hold">Rejected</span>
                                                                at
                                                                {{convertTime(status.timestamp)}}
                                                                <span *ngIf="status.notes"><br>Notes: {{status.notes}}</span>
                                                            </h4>
                                                            <h4 class="job-status"
                                                                *ngIf="status.status_id === 9">
                                                                <span ion-text color="complete">Completed</span>
                                                                at
                                                                {{convertTime(status.timestamp)}}
                                                                <span *ngIf="status.notes"><br>Notes: {{status.notes}}</span>
                                                            </h4>


                                                        </div>
                                                    </div>

                                                    <button ion-button icon-left medium class="margin-left18"
                                                            *ngIf="crewMember.status_id === 5 || crewMember.status_id === 6 || crewMember.status_id === 7 || crewMember.status_id === 12"
                                                            (click)="loadNotes(crewMember.employee_id, task.id)">
                                                        <div *ngIf="employeeId === -1 || employeeId !== crewMember.employee_id">
                                                            See Images
                                                        </div>
                                                        <div *ngIf="employeeId === crewMember.employee_id">
                                                            Hide Images
                                                        </div>
                                                    </button>

                                                    <div *ngIf="employeeId === crewMember.employee_id && employeeId !== -1 && displayOptions.task === j && displayOptions.proj === i">

                                                        <div *ngFor="let note of delayNotes">
                                                            <div *ngFor="let image of note.images">
                                                                <img class="mar-bot10" src="{{image}}">
                                                            </div>
                                                        </div>


                                                    </div>

                                                </ion-col>

                                            </ion-row>


                                            <div *ngIf="task.task_crew.length === 0">No Crew Specified</div>
                                        </div>

                                    </ion-card-content>
                                </ion-card>

                                <ion-card class="card-border" *ngIf="role_id !== 6">
                                    <ion-card-header class="task-card-header">
                                        Equipment
                                    </ion-card-header>
                                    <ion-card-content>
                                        <div class="task-card-content">

                                            <div class="equip-div" *ngFor="let item of task.task_equipment">
                                                <h4 class="equip-name">{{item.equipment_name}}</h4>
                                                <h4 class="equip-assig" *ngIf="item.employee_id === 0">Assigned
                                                    Employee: <span class="equip-bold">Unassigned</span>
                                                </h4>
                                                <h4 class="equip-assig" *ngIf="item.employee_id !== 0">Assigned
                                                    Employee: <span class="equip-bold">{{getEmployeeName(task.task_crew, item)}}</span>
                                                </h4>
                                            </div>

                                            <div class="equip-center" *ngIf="task.task_equipment.length === 0">
                                                No Equipment Specified
                                            </div>
                                        </div>
                                    </ion-card-content>
                                </ion-card>

                                <ion-card class="card-border">
                                    <!-- // allow this card to scroll above the footer buttons // -->
                                    <ion-card-header class="task-card-header">
                                        Materials/Supplier
                                    </ion-card-header>
                                    <ion-card-content>
                                        <div class="multiple-suppliers"
                                             *ngFor="let material of task.task_materials; let m = index">
                                            <div class="task-card-content" *ngIf="task.task_materials">

                                                <h3 class="text-info">{{material.material_name}}</h3>
                                                <ion-list no-padding>
                                                    <ion-item no-padding>
                                                        <!--<ion-icon name="map" item-right></ion-icon>-->
                                                        <p style="font-weight:bold">Supplier:
                                                            {{material.supplier.name}}
                                                        </p>
                                                        <p>
                                                            <button ion-button icon-left clear medium
                                                                    class="phoneNum"
                                                                    (click)="callPhone(material.supplier.phone)">
                                                                {{material.supplier.phone}}
                                                            </button>
                                                        </p>
                                                        <div>{{material.supplier.address}}</div>
                                                        <div>{{material.supplier.city}},
                                                            {{material.supplier.state}}&nbsp;{{material.supplier.zip}}
                                                        </div>
                                                        <ion-col>
                                                            <button class="gen-mar-bot20" ion-button icon-left clear
                                                                    medium
                                                                    (click)="showDrivingDirections(material.supplier.lat, material.supplier.lon)">
                                                                <ion-icon name="navigate"></ion-icon>
                                                                Get Directions
                                                            </button>
                                                        </ion-col>
                                                    </ion-item>
                                                </ion-list>

                                            </div>

                                        </div>
                                        <div class="task-card-content equip-center"
                                             *ngIf="task.task_materials.length === 0">No
                                            Materials Specified
                                        </div>
                                    </ion-card-content>
                                </ion-card>
                            </div>
                        </div>
                    </div>
                </ion-card-content>

            </ion-card>


        </div>
    </div>


</ion-content>

<!--old foreman stuff-->


<div *ngIf="projTaskLength.proj === 0">
    <div ion-fixed class="fs-no-results-container-ios">
        <div class="content">
            <!--<ion-icon name="paper-plane"></ion-icon>-->
            <div class="fs-no-results-msg">You Do Not Have<br/>Any Foreman Tasks</div>
            <div class="button-container">
                <button class="home-btn" ion-button icon-right block color="secondary" (click)="refreshCrews()">
                    Check for Tasks
                </button>
            </div>
        </div>
    </div>
</div>

